<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>War & Markets: How U.S. Stocks React to Conflict</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<style>
  :root {
    --bg: #0F172A;
    --surface: #1E293B;
    --surface-elevated: #334155;
    --text-primary: #F8FAFC;
    --text-secondary: #CBD5E1;
    --text-muted: #94A3B8;
    --border: #334155;
    --border-light: #475569;
    --indigo: #6366F1;
    --indigo-light: #818CF8;
    --emerald: #10B981;
    --emerald-light: #34D399;
    --amber: #F59E0B;
    --amber-light: #FBBF24;
    --red: #EF4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text-primary);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    line-height: 1.6;
    padding: 2rem 1rem;
  }

  .container { max-width: 960px; margin: 0 auto; }

  /* Header */
  .header { text-align: center; margin-bottom: 3rem; }
  .header h1 {
    font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;
    background: linear-gradient(135deg, var(--indigo-light), var(--emerald-light));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .header .subtitle { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 1rem; }
  .header .methodology {
    font-size: 0.85rem; color: var(--text-muted);
    max-width: 700px; margin: 0 auto; line-height: 1.5;
  }

  /* Section titles */
  .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); }
  .section-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem; }

  /* Chart containers */
  .chart-section {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;
  }

  svg text { font-family: 'Inter', system-ui, sans-serif; }

  /* Tooltip */
  .tooltip {
    position: absolute; pointer-events: none;
    background: var(--surface-elevated); border: 1px solid var(--border-light);
    border-radius: 8px; padding: 12px 16px; font-size: 0.8rem;
    color: var(--text-primary); line-height: 1.6;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    opacity: 0; transition: opacity 0.15s ease;
    z-index: 100; max-width: 280px;
  }
  .tooltip .tt-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; }
  .tooltip .tt-label { color: var(--text-muted); }
  .tooltip .tt-value { font-weight: 500; }

  /* Legend */
  .legend { display: flex; gap: 1.5rem; justify-content: center; margin-bottom: 1rem; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary); }
  .legend-swatch { width: 14px; height: 14px; border-radius: 3px; }

  /* Tables */
  .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
  .table-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 1.25rem; overflow-x: auto;
  }
  .table-card h3 {
    font-size: 1rem; font-weight: 600; margin-bottom: 1rem;
    display: flex; align-items: center; gap: 8px;
  }
  .table-card h3 .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
  table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  th {
    text-align: left; padding: 8px 10px; color: var(--text-muted);
    font-weight: 500; font-size: 0.75rem; text-transform: uppercase;
    letter-spacing: 0.05em; border-bottom: 1px solid var(--border);
  }
  td { padding: 8px 10px; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface-elevated); }
  td.decline { color: var(--red); font-weight: 600; }

  /* Buildup cards */
  .buildup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }
  .buildup-card {
    background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem;
  }
  .buildup-card h3 { font-weight: 600; color: #E2E8F0; font-size: 0.9rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
  .buildup-card .badge {
    font-size: 0.6rem; font-weight: 600; color: var(--amber-light); background: rgba(251,191,36,0.12);
    padding: 2px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.05em;
  }
  .buildup-card .meta-label { font-size: 0.68rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
  .buildup-card .meta-value { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
  .buildup-card .change-val { font-size: 1.15rem; font-weight: 700; }
  .buildup-card .change-val.neg { color: var(--red); }
  .buildup-card .change-val.pos { color: var(--emerald); }
  .buildup-card .narrative { font-size: 0.78rem; color: var(--text-muted); line-height: 1.5; border-top: 1px solid var(--border); padding-top: 0.6rem; margin-top: 0.6rem; }
  .buildup-note { font-size: 0.72rem; color: var(--text-muted); text-align: center; font-style: italic; margin-top: 0.5rem; }

  /* Tabs */
  .tab-bar { display: flex; gap: 8px; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap; }
  .tab-btn {
    padding: 10px 24px; font-size: 0.9rem; font-weight: 400; font-family: inherit;
    color: var(--text-muted); background: transparent; border: 1px solid transparent;
    border-radius: 8px; cursor: pointer; transition: all 0.15s ease;
  }
  .tab-btn.active {
    font-weight: 600; color: var(--text-primary); background: var(--surface-elevated);
    border-color: var(--border-light);
  }
  .tab-btn:hover:not(.active) { color: var(--text-secondary); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Footer */
  .footer {
    text-align: center; color: var(--text-muted); font-size: 0.75rem;
    padding-top: 1rem; border-top: 1px solid var(--border); line-height: 1.8;
  }
  .footer a { color: var(--indigo-light); text-decoration: none; }
  .footer a:hover { text-decoration: underline; }

  @media (max-width: 768px) {
    body { padding: 1rem 0.75rem; }
    .header h1 { font-size: 1.5rem; }
    .header .subtitle { font-size: 0.95rem; }
    .tables-grid { grid-template-columns: 1fr; }
    .buildup-grid { grid-template-columns: 1fr; }
    .chart-section { padding: 1rem; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>War & Markets</h1>
    <p class="subtitle">How U.S. Stocks React to the Onset of Major Conflicts</p>
    <p class="methodology">
      S&P 500 (DJIA proxy pre-1957) and NASDAQ Composite drawdowns measured from the
      trading day before each conflict's start event. Recovery = return to pre-war close.
      NASDAQ data available from 1971 onward (Gulf War, 9/11, Iraq only).
    </p>
  </div>

  <!-- Tab bar -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('reaction')">Post-Conflict Reaction</button>
    <button class="tab-btn" onclick="switchTab('buildup')">Pre-War Buildup</button>
  </div>

  <!-- TAB 1: Post-Conflict Reaction -->
  <div class="tab-content active" id="tab-reaction">
    <!-- Bar Chart: Max Decline -->
    <div class="chart-section">
      <h2 class="section-title">Maximum Drawdown by Conflict</h2>
      <p class="section-desc">Peak-to-trough decline from the pre-war close</p>
      <div class="legend">
        <div class="legend-item"><div class="legend-swatch" style="background:var(--indigo)"></div><span>S&P 500</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:var(--emerald)"></div><span>NASDAQ</span></div>
      </div>
      <div id="bar-chart"></div>
    </div>

    <!-- Dumbbell Chart -->
    <div class="chart-section">
      <h2 class="section-title">Speed of Decline vs. Recovery</h2>
      <p class="section-desc">Trading days from conflict start to market bottom, and from bottom back to pre-war level</p>
      <div class="legend">
        <div class="legend-item"><div class="legend-swatch" style="background:var(--amber);border-radius:50%"></div><span>Days to bottom</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:var(--emerald);border-radius:50%"></div><span>Days to recover</span></div>
        <div class="legend-item">
          <svg width="14" height="14"><line x1="0" y1="7" x2="14" y2="7" stroke="#94A3B8" stroke-width="2"/></svg>
          <span>S&P 500</span>
        </div>
        <div class="legend-item">
          <svg width="14" height="14"><line x1="0" y1="7" x2="14" y2="7" stroke="#94A3B8" stroke-width="2" stroke-dasharray="3,3"/></svg>
          <span>NASDAQ</span>
        </div>
      </div>
      <div id="dumbbell-chart"></div>
    </div>

    <!-- Data Tables -->
    <div class="tables-grid">
      <div class="table-card">
        <h3><span class="dot" style="background:var(--indigo)"></span> S&P 500</h3>
        <table>
          <thead><tr><th>Conflict</th><th>Date</th><th>Decline</th><th>Days Down</th><th>Days Recover</th></tr></thead>
          <tbody id="sp500-table"></tbody>
        </table>
      </div>
      <div class="table-card">
        <h3><span class="dot" style="background:var(--emerald)"></span> NASDAQ</h3>
        <table>
          <thead><tr><th>Conflict</th><th>Date</th><th>Decline</th><th>Days Down</th><th>Days Recover</th></tr></thead>
          <tbody id="nasdaq-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 2: Pre-War Buildup -->
  <div class="tab-content" id="tab-buildup">
    <div class="chart-section">
      <h2 class="section-title">Pre-War Market Buildup</h2>
      <p class="section-desc">How markets performed in the lead-up to each conflict — anticipatory selloffs vs. surprise shocks</p>
      <div class="legend">
        <div class="legend-item"><div class="legend-swatch" style="background:var(--indigo)"></div><span>S&P 500</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:var(--emerald)"></div><span>NASDAQ</span></div>
        <div class="legend-item" style="opacity:0.5"><div class="legend-swatch" style="background:#94A3B8"></div><span>Surprise (context)</span></div>
      </div>
      <div id="buildup-chart"></div>
      <p class="buildup-note">Faded bars = surprise events (context only, not anticipatory). Positive values = market was rising before the conflict.</p>

      <div class="buildup-grid" id="buildup-cards"></div>
    </div>
  </div>

  <div class="footer">
    Data sources: Yahoo Finance (via yfinance), iSectors, Hennion & Walsh, The Motley Fool, CFA Institute, Invesco<br>
    S&P 500 uses DJIA as proxy for pre-1957 conflicts (WWII, Korea). NASDAQ began trading in 1971.
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
// ── TAB SWITCHING ────────────────────────────────────────────
function switchTab(id) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  document.getElementById("tab-" + id).classList.add("active");
  document.querySelector(`.tab-btn[onclick="switchTab('${id}')"]`).classList.add("active");
}

// ── DATA ──────────────────────────────────────────────────────
const sp500Data = [
  { conflict: "WWII",     label: "WWII (Pearl Harbor)",      date: "Dec 7, 1941",  decline: 20.3, daysToBottom: 143, daysToRecover: 917 },
  { conflict: "Korea",    label: "Korean War",                date: "Jun 25, 1950", decline: 12.0, daysToBottom: 18,  daysToRecover: 60  },
  { conflict: "Vietnam",  label: "Vietnam (Gulf of Tonkin)",  date: "Aug 7, 1964",  decline: 5.0,  daysToBottom: 26,  daysToRecover: 50  },
  { conflict: "Gulf War", label: "Gulf War (Kuwait)",         date: "Aug 2, 1990",  decline: 16.9, daysToBottom: 71,  daysToRecover: 189 },
  { conflict: "9/11",     label: "9/11 / Afghanistan",        date: "Sep 11, 2001", decline: 11.6, daysToBottom: 10,  daysToRecover: 31  },
  { conflict: "Iraq",     label: "Iraq War",                  date: "Mar 19, 2003", decline: 5.3,  daysToBottom: 10,  daysToRecover: 16  },
];

const nasdaqData = [
  { conflict: "Gulf War", label: "Gulf War (Kuwait)",  date: "Aug 2, 1990",  decline: 24.1, daysToBottom: 75,  daysToRecover: 187, preClose: 428.90,  bottomClose: 325.40  },
  { conflict: "9/11",     label: "9/11 / Afghanistan", date: "Sep 11, 2001", decline: 16.1, daysToBottom: 11,  daysToRecover: 31,  preClose: 1695.38, bottomClose: 1423.19 },
  { conflict: "Iraq",     label: "Iraq War",           date: "Mar 19, 2003", decline: 4.0,  daysToBottom: 12,  daysToRecover: 29,  preClose: 1397.07, bottomClose: 1341.17 },
];

const nasdaqMap = Object.fromEntries(nasdaqData.map(d => [d.conflict, d]));
const conflicts = sp500Data.map(d => d.conflict);
const tooltip = d3.select("#tooltip");

function showTooltip(event, html) {
  tooltip.html(html).style("opacity", 1);
  const ttRect = tooltip.node().getBoundingClientRect();
  let tx = event.pageX + 14, ty = event.pageY - 14;
  if (tx + ttRect.width > window.innerWidth - 20) tx = event.pageX - ttRect.width - 14;
  if (ty + ttRect.height > window.innerHeight + window.scrollY - 20) ty = event.pageY - ttRect.height - 14;
  tooltip.style("left", tx + "px").style("top", ty + "px");
}
function hideTooltip() { tooltip.style("opacity", 0); }

// ── PRE-WAR BUILDUP DATA ─────────────────────────────────────
const preWarData = [
  { conflict: "WWII", label: "WWII (Pearl Harbor)", period: "Jul 25 – Dec 5, 1941", days: 91,
    spChange: -9.9, nqChange: null, surprise: false, spStart: "10.34", spEnd: "9.32",
    catalyst: "US freezes Japanese assets, oil embargo (Jul 26)",
    narrative: "Gradual decline as US-Japan tensions escalated after the asset freeze cut off 80% of Japan's oil. Pearl Harbor itself was a surprise, but the collision course was visible." },
  { conflict: "Korea", label: "Korean War", period: "None (surprise invasion)", days: null,
    spChange: 11.0, nqChange: null, surprise: true, spStart: "17.24", spEnd: "19.14",
    catalyst: "North Korea invaded with no warning (Jun 25, 1950)",
    narrative: "Complete surprise. Markets were at 52-week highs, up +11% in the prior 3 months. The S&P fell 5.4% on the first trading day after." },
  { conflict: "Vietnam", label: "Vietnam (Gulf of Tonkin)", period: "Feb 3 – Aug 7, 1964", days: 131,
    spChange: 6.4, nqChange: null, surprise: false, spStart: "76.97", spEnd: "81.86",
    catalyst: "Gulf of Tonkin incident (Aug 2–4)",
    narrative: "Markets showed zero concern about Vietnam in 1964. The S&P rose steadily and barely flinched at Tonkin. War's economic impact wouldn't hit until 1966." },
  { conflict: "Gulf War", label: "Gulf War (Kuwait)", period: "Jul 16 – Aug 1, 1990", days: 13,
    spChange: -3.6, nqChange: -7.2, surprise: false, spStart: "368.95", spEnd: "355.52", nqStart: "469.60", nqEnd: "435.90",
    catalyst: "Saddam threatens Kuwait (Jul 17), troops mass on border",
    narrative: "S&P peaked the day before Saddam's threatening speech. Brief 2-week selloff. NASDAQ fell harder (−7.2%) as tech was more sensitive to oil shock fears." },
  { conflict: "9/11", label: "9/11 / Afghanistan", period: "None (surprise attack)", days: null,
    spChange: -20.5, nqChange: -21.9, surprise: true, spStart: "1,373.73", spEnd: "1,092.54", nqStart: "2,170.78", nqEnd: "1,695.38",
    catalyst: "Terrorist attacks — completely unexpected",
    narrative: "No pre-war buildup. Both indices were already in severe decline from the dot-com bust. S&P down 28.5% from 2000 peak; NASDAQ down 66% from its March 2000 high." },
  { conflict: "Iraq", label: "Iraq War", period: "Nov 27, 2002 – Mar 11, 2003", days: 70,
    spChange: -14.7, nqChange: -5.9, surprise: false, spStart: "938.87", spEnd: "800.73", nqStart: "1,487.94", nqEnd: "1,400.55",
    catalyst: "UN Resolution 1441 → Powell UN speech → Bush ultimatum",
    narrative: "The textbook 'sell the buildup, buy the invasion.' S&P fell 14.7% as war certainty grew. Once the invasion began, markets immediately rallied." },
];

// ── BUILDUP CHART ────────────────────────────────────────────
(function() {
  const container = d3.select("#buildup-chart");
  const fullWidth = Math.min(container.node().getBoundingClientRect().width, 900);
  const margin = { top: 10, right: 60, bottom: 40, left: 160 };
  const width = fullWidth - margin.left - margin.right;
  const height = preWarData.length * 72;

  const svg = container.append("svg")
    .attr("viewBox", `0 0 ${fullWidth} ${height + margin.top + margin.bottom}`)
    .attr("preserveAspectRatio", "xMidYMid meet")
    .style("width", "100%").style("max-width", fullWidth + "px");

  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const y0 = d3.scaleBand().domain(preWarData.map(d => d.conflict)).range([0, height]).padding(0.25);
  const vals = preWarData.flatMap(d => [d.spChange, d.nqChange].filter(v => v != null));
  const xMin = Math.floor(d3.min(vals) / 5) * 5;
  const xMax = Math.ceil(d3.max(vals) / 5) * 5;
  const x = d3.scaleLinear().domain([xMin, xMax]).range([0, width]);

  // Grid
  const gridG = g.append("g");
  gridG.call(d3.axisBottom(x).tickSize(height).tickFormat("").ticks(6));
  gridG.select(".domain").remove();
  gridG.selectAll("line").attr("stroke", "#475569").attr("stroke-opacity", 0.25);
  gridG.selectAll("text").remove();

  // Zero line
  g.append("line")
    .attr("x1", x(0)).attr("y1", 0).attr("x2", x(0)).attr("y2", height)
    .attr("stroke", "#64748B").attr("stroke-width", 1.5);

  // Y axis
  const yAxisG = g.append("g").call(d3.axisLeft(y0).tickSize(0).tickFormat(c => {
    const d = preWarData.find(dd => dd.conflict === c);
    return d ? d.label : c;
  }));
  yAxisG.select(".domain").remove();
  yAxisG.selectAll("text").attr("fill", "#CBD5E1").attr("font-size", "0.78rem");

  // X axis
  const xAxisG = g.append("g").attr("transform", `translate(0,${height})`);
  xAxisG.call(d3.axisBottom(x).ticks(6).tickFormat(d => (d > 0 ? "+" : "") + d + "%"));
  xAxisG.select(".domain").remove();
  xAxisG.selectAll("text").attr("fill", "#94A3B8").attr("font-size", "0.72rem");
  xAxisG.selectAll("line").attr("stroke", "#475569");

  function buildupTip(d, index, change) {
    return `<div class="tt-title">${d.label} — ${index}</div>
      <span class="tt-label">Period:</span> <span class="tt-value">${d.period}</span><br>
      <span class="tt-label">Change:</span> <span class="tt-value" style="color:${change < 0 ? '#EF4444' : '#10B981'}">${change > 0 ? '+' : ''}${change}%</span><br>
      <span class="tt-label">Catalyst:</span> <span class="tt-value">${d.catalyst}</span>
      ${d.surprise ? '<br><span style="color:#FBBF24;font-style:italic;font-size:0.72rem">Surprise event — context only</span>' : ''}`;
  }

  preWarData.forEach(d => {
    const nq = d.nqChange;
    const hasNQ = nq != null;
    const bandH = y0.bandwidth();
    const opacity = d.surprise ? 0.4 : 1;

    function addBuildupBar(yPos, h, fill, change, tipHtml) {
      const barX = change < 0 ? x(change) : x(0);
      const barW = Math.abs(x(change) - x(0));
      g.append("rect").attr("class", "bar")
        .attr("x", barX).attr("y", yPos).attr("width", 0).attr("height", h)
        .attr("rx", 4).attr("fill", fill).attr("opacity", opacity)
        .on("mouseenter", function(event) {
          d3.selectAll(".bar").attr("opacity", 0.25);
          d3.select(this).attr("opacity", 1);
          showTooltip(event, tipHtml);
        })
        .on("mousemove", event => showTooltip(event, tooltip.html()))
        .on("mouseleave", function() { d3.selectAll(".bar").attr("opacity", b => b === d ? opacity : 1); hideTooltip(); })
        .transition().duration(800).ease(d3.easeCubicOut).attr("width", barW);

      // Label
      const labelX = change < 0 ? barX - 6 : barX + barW + 6;
      const anchor = change < 0 ? "end" : "start";
      g.append("text")
        .attr("x", labelX).attr("y", yPos + h / 2).attr("dy", "0.35em")
        .attr("fill", change < 0 ? "#EF4444" : "#10B981").attr("font-size", "0.72rem").attr("font-weight", "600")
        .attr("text-anchor", anchor).attr("opacity", 0)
        .text(`${change > 0 ? '+' : ''}${change}%`)
        .transition().delay(600).duration(400).attr("opacity", opacity);
    }

    if (hasNQ) {
      const barH = bandH / 2 - 3;
      addBuildupBar(y0(d.conflict), barH, "#6366F1", d.spChange, buildupTip(d, "S&P 500", d.spChange));
      addBuildupBar(y0(d.conflict) + barH + 6, barH, "#10B981", nq, buildupTip(d, "NASDAQ", nq));
    } else {
      const barH = bandH * 0.55;
      addBuildupBar(y0(d.conflict) + (bandH - barH) / 2, barH, "#6366F1", d.spChange, buildupTip(d, "S&P 500", d.spChange));
    }
  });
})();

// ── BUILDUP CARDS ────────────────────────────────────────────
(function() {
  const grid = d3.select("#buildup-cards");
  preWarData.forEach(d => {
    const isNeg = d.spChange < 0;
    const card = grid.append("div").attr("class", "buildup-card");

    let h3 = `${d.label}`;
    if (d.surprise) h3 += `<span class="badge">Surprise</span>`;
    card.append("h3").html(h3);

    card.append("div").attr("class", "meta-label").text(d.surprise ? "Context Period" : "Buildup Period");
    card.append("div").attr("class", "meta-value").text(d.period + (d.days ? ` (${d.days} trading days)` : ""));

    card.append("div").attr("class", "meta-label").text("Catalyst");
    card.append("div").attr("class", "meta-value").text(d.catalyst);

    const row = card.append("div").style("display", "flex").style("gap", "1.5rem").style("margin-bottom", "0.5rem");
    const spCol = row.append("div");
    spCol.append("div").attr("class", "meta-label").text("S&P 500");
    spCol.append("div").attr("class", `change-val ${isNeg ? 'neg' : 'pos'}`).text(`${d.spChange > 0 ? '+' : ''}${d.spChange}%`);
    spCol.append("div").style("font-size", "0.68rem").style("color", "#475569").text(`${d.spStart} → ${d.spEnd}`);

    if (d.nqChange != null) {
      const nqCol = row.append("div");
      nqCol.append("div").attr("class", "meta-label").text("NASDAQ");
      nqCol.append("div").attr("class", `change-val ${d.nqChange < 0 ? 'neg' : 'pos'}`).text(`${d.nqChange > 0 ? '+' : ''}${d.nqChange}%`);
      nqCol.append("div").style("font-size", "0.68rem").style("color", "#475569").text(`${d.nqStart} → ${d.nqEnd}`);
    }

    card.append("div").attr("class", "narrative").text(d.narrative);
  });
})();

// ── BAR CHART ─────────────────────────────────────────────────
(function() {
  const container = d3.select("#bar-chart");
  const fullWidth = Math.min(container.node().getBoundingClientRect().width, 900);
  const margin = { top: 10, right: 60, bottom: 40, left: 160 };
  const width = fullWidth - margin.left - margin.right;
  const height = conflicts.length * 72;

  const svg = container.append("svg")
    .attr("viewBox", `0 0 ${fullWidth} ${height + margin.top + margin.bottom}`)
    .attr("preserveAspectRatio", "xMidYMid meet")
    .style("width", "100%").style("max-width", fullWidth + "px");

  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const y0 = d3.scaleBand().domain(conflicts).range([0, height]).padding(0.25);
  const maxVal = d3.max([...sp500Data.map(d => d.decline), ...nasdaqData.map(d => d.decline)]);
  const x = d3.scaleLinear().domain([0, Math.ceil(maxVal / 5) * 5]).range([0, width]);

  // Grid
  const gridG = g.append("g").attr("class", "grid");
  gridG.call(d3.axisBottom(x).tickSize(height).tickFormat("").ticks(5));
  gridG.select(".domain").remove();
  gridG.selectAll("line").attr("stroke", "#475569").attr("stroke-opacity", 0.25);
  gridG.selectAll("text").remove();

  // Y axis
  const yAxisG = g.append("g").call(d3.axisLeft(y0).tickSize(0).tickFormat(c => {
    const sp = sp500Data.find(d => d.conflict === c);
    return sp ? sp.label : c;
  }));
  yAxisG.select(".domain").remove();
  yAxisG.selectAll("text").attr("fill", "#CBD5E1").attr("font-size", "0.78rem");

  // X axis
  const xAxisG = g.append("g").attr("transform", `translate(0,${height})`);
  xAxisG.call(d3.axisBottom(x).ticks(5).tickFormat(d => d + "%"));
  xAxisG.select(".domain").remove();
  xAxisG.selectAll("text").attr("fill", "#94A3B8").attr("font-size", "0.72rem");
  xAxisG.selectAll("line").attr("stroke", "#475569");

  // Bars per conflict
  conflicts.forEach(conflict => {
    const sp = sp500Data.find(d => d.conflict === conflict);
    const nq = nasdaqMap[conflict];
    const bandH = y0.bandwidth();

    function barTip(index, data) {
      let html = `<div class="tt-title">${data.label}</div>
        <span class="tt-label">Index:</span> <span class="tt-value">${index}</span><br>
        <span class="tt-label">Date:</span> <span class="tt-value">${data.date}</span><br>
        <span class="tt-label">Max decline:</span> <span class="tt-value" style="color:#EF4444">-${data.decline}%</span><br>
        <span class="tt-label">Days to bottom:</span> <span class="tt-value">${data.daysToBottom}</span><br>
        <span class="tt-label">Days to recover:</span> <span class="tt-value">${data.daysToRecover}</span>`;
      if (data.preClose) html += `<br><span class="tt-label">Pre-war:</span> <span class="tt-value">${data.preClose.toLocaleString()}</span>`;
      if (!nq && index === "S&P 500") html += `<br><span class="tt-label" style="font-style:italic;color:#94A3B8">NASDAQ not yet trading</span>`;
      return html;
    }

    function addBar(yPos, h, fill, data, indexName) {
      g.append("rect").attr("class", "bar")
        .attr("x", 0).attr("y", yPos).attr("width", 0).attr("height", h)
        .attr("rx", 4).attr("fill", fill)
        .on("mouseenter", function(event) {
          d3.selectAll(".bar").attr("opacity", 0.35);
          d3.select(this).attr("opacity", 1);
          showTooltip(event, barTip(indexName, data));
        })
        .on("mousemove", event => showTooltip(event, tooltip.html()))
        .on("mouseleave", function() { d3.selectAll(".bar").attr("opacity", 1); hideTooltip(); })
        .transition().duration(800).ease(d3.easeCubicOut)
        .attr("width", x(data.decline));

      // Label at end of bar
      g.append("text")
        .attr("x", x(data.decline) + 6).attr("y", yPos + h / 2).attr("dy", "0.35em")
        .attr("fill", "#CBD5E1").attr("font-size", "0.72rem").attr("font-weight", "600")
        .attr("opacity", 0).text(`-${data.decline}%`)
        .transition().delay(600).duration(400).attr("opacity", 1);
    }

    if (nq) {
      const barH = bandH / 2 - 3;
      addBar(y0(conflict), barH, "#6366F1", sp, "S&P 500");
      addBar(y0(conflict) + barH + 6, barH, "#10B981", nq, "NASDAQ");
    } else {
      const barH = bandH * 0.55;
      addBar(y0(conflict) + (bandH - barH) / 2, barH, "#6366F1", sp, "S&P 500");
    }
  });
})();

// ── DUMBBELL CHART ────────────────────────────────────────────
(function() {
  const container = d3.select("#dumbbell-chart");
  const fullWidth = Math.min(container.node().getBoundingClientRect().width, 900);
  const margin = { top: 10, right: 90, bottom: 45, left: 160 };
  const width = fullWidth - margin.left - margin.right;
  const height = conflicts.length * 72;

  const svg = container.append("svg")
    .attr("viewBox", `0 0 ${fullWidth} ${height + margin.top + margin.bottom}`)
    .attr("preserveAspectRatio", "xMidYMid meet")
    .style("width", "100%").style("max-width", fullWidth + "px");

  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const allDays = [...sp500Data.flatMap(d => [d.daysToBottom, d.daysToRecover]),
                   ...nasdaqData.flatMap(d => [d.daysToBottom, d.daysToRecover])];
  const x = d3.scaleLinear().domain([0, d3.max(allDays) * 1.08]).range([0, width]);
  const y = d3.scaleBand().domain(conflicts).range([0, height]).padding(0.35);

  // Grid
  const gridG = g.append("g");
  gridG.call(d3.axisBottom(x).tickSize(height).tickFormat("").ticks(6));
  gridG.select(".domain").remove();
  gridG.selectAll("line").attr("stroke", "#475569").attr("stroke-opacity", 0.2);
  gridG.selectAll("text").remove();

  // Y axis
  const yAxisG = g.append("g").call(d3.axisLeft(y).tickSize(0).tickFormat(c => {
    const sp = sp500Data.find(d => d.conflict === c);
    return sp ? sp.label : c;
  }));
  yAxisG.select(".domain").remove();
  yAxisG.selectAll("text").attr("fill", "#CBD5E1").attr("font-size", "0.78rem");

  // X axis
  const xAxisG = g.append("g").attr("transform", `translate(0,${height})`);
  xAxisG.call(d3.axisBottom(x).ticks(6).tickFormat(d => d + "d"));
  xAxisG.select(".domain").remove();
  xAxisG.selectAll("text").attr("fill", "#94A3B8").attr("font-size", "0.72rem");
  xAxisG.selectAll("line").attr("stroke", "#475569");

  g.append("text").attr("x", width / 2).attr("y", height + 38)
    .attr("text-anchor", "middle").attr("fill", "#94A3B8").attr("font-size", "0.72rem")
    .text("Trading Days");

  function dotTip(label, index, metric, value, extra) {
    return `<div class="tt-title">${label} — ${index}</div>
      <span class="tt-label">${metric}:</span> <span class="tt-value" style="color:${metric.includes("bottom") ? "#F59E0B" : "#10B981"}">${value} days</span>
      ${extra || ""}`;
  }

  function addDot(cx, cy, r, fill, tipHtml) {
    g.append("circle").attr("class", "dot")
      .attr("cx", cx).attr("cy", cy).attr("r", r)
      .attr("fill", fill).attr("stroke", "transparent").attr("stroke-width", 2.5)
      .on("mouseenter", function(event) {
        d3.select(this).transition().duration(120).attr("r", r * 1.5).attr("stroke", "#fff");
        showTooltip(event, tipHtml);
      })
      .on("mousemove", event => showTooltip(event, tooltip.html()))
      .on("mouseleave", function() {
        d3.select(this).transition().duration(120).attr("r", r).attr("stroke", "transparent");
        hideTooltip();
      });
  }

  conflicts.forEach(conflict => {
    const sp = sp500Data.find(d => d.conflict === conflict);
    const nq = nasdaqMap[conflict];
    const cy = y(conflict) + y.bandwidth() / 2;
    const hasNQ = !!nq;
    const spY = hasNQ ? cy - 10 : cy;

    // S&P connecting line (solid)
    g.append("line")
      .attr("x1", x(sp.daysToBottom)).attr("y1", spY)
      .attr("x2", x(sp.daysToRecover)).attr("y2", spY)
      .attr("stroke", "#64748B").attr("stroke-width", 2);

    addDot(x(sp.daysToBottom), spY, 7, "#F59E0B",
      dotTip(sp.label, "S&P 500", "Days to bottom", sp.daysToBottom,
        `<br><span class="tt-label">Max decline:</span> <span class="tt-value" style="color:#EF4444">-${sp.decline}%</span>`));
    addDot(x(sp.daysToRecover), spY, 7, "#10B981",
      dotTip(sp.label, "S&P 500", "Days to recover", sp.daysToRecover,
        `<br><span class="tt-label">Drawdown:</span> <span class="tt-value">-${sp.decline}% in ${sp.daysToBottom}d</span>`));

    if (hasNQ) {
      const nqY = cy + 10;
      g.append("line")
        .attr("x1", x(nq.daysToBottom)).attr("y1", nqY)
        .attr("x2", x(nq.daysToRecover)).attr("y2", nqY)
        .attr("stroke", "#64748B").attr("stroke-width", 2).attr("stroke-dasharray", "5,4");

      addDot(x(nq.daysToBottom), nqY, 5.5, "#F59E0B",
        dotTip(nq.label, "NASDAQ", "Days to bottom", nq.daysToBottom,
          `<br><span class="tt-label">Max decline:</span> <span class="tt-value" style="color:#EF4444">-${nq.decline}%</span>`));
      addDot(x(nq.daysToRecover), nqY, 5.5, "#10B981",
        dotTip(nq.label, "NASDAQ", "Days to recover", nq.daysToRecover,
          `<br><span class="tt-label">Drawdown:</span> <span class="tt-value">-${nq.decline}% in ${nq.daysToBottom}d</span>`));
    }

    // WWII outlier annotation
    if (conflict === "WWII") {
      g.append("text").attr("x", x(sp.daysToRecover) + 10).attr("y", spY).attr("dy", "0.35em")
        .attr("fill", "#94A3B8").attr("font-size", "0.68rem").attr("font-style", "italic")
        .text("917 days (~2.5 yrs)");
    }
  });
})();

// ── DATA TABLES ───────────────────────────────────────────────
(function() {
  const sp500Body = d3.select("#sp500-table");
  sp500Data.forEach(d => {
    sp500Body.append("tr").html(
      `<td>${d.label}</td><td>${d.date}</td><td class="decline">-${d.decline}%</td><td>${d.daysToBottom}</td><td>${d.daysToRecover}</td>`
    );
  });

  const nasdaqBody = d3.select("#nasdaq-table");
  nasdaqData.forEach(d => {
    nasdaqBody.append("tr").html(
      `<td>${d.label}</td><td>${d.date}</td><td class="decline">-${d.decline}%</td><td>${d.daysToBottom}</td><td>${d.daysToRecover}</td>`
    );
  });
})();
</script>
</body>
</html>
